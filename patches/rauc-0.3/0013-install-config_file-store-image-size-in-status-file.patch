From 1e02bbc2689024f4b81e3ba9c091c739a728055b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ulrich=20=C3=96lmann?= <u.oelmann@pengutronix.de>
Date: Tue, 5 Sep 2017 15:43:58 +0200
Subject: [PATCH 13/44] install/config_file: store image size in status file
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In the case of a central, comprehensive status file this allows to check the
integrity of a slot's content. In contrast to that, a slot individual file is
stored inside the slot and therefore already modified the slot's content making
this check impossible.

Signed-off-by: Ulrich Ã–lmann <u.oelmann@pengutronix.de>
---
 docs/reference.rst | 12 ++++++++++++
 src/config_file.c  |  8 ++++++--
 src/install.c      |  1 +
 3 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/docs/reference.rst b/docs/reference.rst
index 89267e2..6c1200c 100644
--- a/docs/reference.rst
+++ b/docs/reference.rst
@@ -181,6 +181,8 @@ hierarchical separator.
   which means that updating this slot will be skipped if new image's hash
   matches hash of installed one.
 
+.. _sec_ref_manifest:
+
 Manifest
 --------
 
@@ -244,6 +246,8 @@ A valid manifest file must have the file extension ``.raucm``.
   Arguments to pass to the handler script, such as ``args=--verbose``
 
 
+.. _image.slot-class-section:
+
 **[image.<slot-class>] section**
 
 ``filename``
@@ -285,6 +289,14 @@ termed with the slot name (e.g. [slot.rootfs.1]) for the central status file:
   [slot]
   status=ok
   sha256=b14c1457dc10469418b4154fef29a90e1ffb4dddd308bf0f2456d436963ef5b3
+  size=419430400
+
+For a description of ``sha256`` and ``size`` keys see :ref:`this
+<image.slot-class-section>` part of the section :ref:`Manifest
+<sec_ref_manifest>`.
+Having the slot's content's size allows to re-calculate the hash via `head -c
+<size> <slot-device> | sha256sum` or `dd bs=<size> count=1 if=<slot-device> |
+sha256sum`.
 
 
 Command Line Tool
diff --git a/src/config_file.c b/src/config_file.c
index 5e92f58..f9e712f 100644
--- a/src/config_file.c
+++ b/src/config_file.c
@@ -416,6 +416,7 @@ static void status_file_get_slot_status(GKeyFile *key_file, const gchar *group,
 	if (digest) {
 		slotstatus->checksum.type = G_CHECKSUM_SHA256;
 		slotstatus->checksum.digest = digest;
+		slotstatus->checksum.size = g_key_file_get_uint64(key_file, group, "size", NULL);
 	}
 }
 
@@ -425,10 +426,13 @@ static void status_file_set_slot_status(GKeyFile *key_file, const gchar *group,
 	else
 		g_key_file_remove_key(key_file, group, "status", NULL);
 
-	if (slotstatus->checksum.digest && slotstatus->checksum.type == G_CHECKSUM_SHA256)
+	if (slotstatus->checksum.digest && slotstatus->checksum.type == G_CHECKSUM_SHA256) {
 		g_key_file_set_string(key_file, group, "sha256", slotstatus->checksum.digest);
-	else
+		g_key_file_set_uint64(key_file, group, "size", slotstatus->checksum.size);
+	} else {
 		g_key_file_remove_key(key_file, group, "sha256", NULL);
+		g_key_file_remove_key(key_file, group, "size", NULL);
+	}
 
 	return;
 }
diff --git a/src/install.c b/src/install.c
index 551044d..0fa80d5 100644
--- a/src/install.c
+++ b/src/install.c
@@ -930,6 +930,7 @@ static gboolean launch_and_wait_default_handler(RaucInstallArgs *args, gchar* bu
 		slot_state->status = g_strdup("ok");
 		slot_state->checksum.type = mfimage->checksum.type;
 		slot_state->checksum.digest = g_strdup(mfimage->checksum.digest);
+		slot_state->checksum.size = mfimage->checksum.size;
 
 		r_context_end_step("copy_image", TRUE);
 
-- 
2.14.1

