From d4dbb4a23e373c0d31cfb08e47526eb9044a5914 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ulrich=20=C3=96lmann?= <u.oelmann@pengutronix.de>
Date: Thu, 31 Aug 2017 13:01:15 +0200
Subject: [PATCH 10/44] install/config_file: modification of status information
 is orthogonal to saving them
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Hence move the modification of the status information to the code that performs
the underlying modifications.

Signed-off-by: Ulrich Ã–lmann <u.oelmann@pengutronix.de>
---
 include/config_file.h |  3 +--
 src/config_file.c     | 13 ++-----------
 src/install.c         |  9 ++++++++-
 3 files changed, 11 insertions(+), 14 deletions(-)

diff --git a/include/config_file.h b/include/config_file.h
index 5d50919..0d57f99 100644
--- a/include/config_file.h
+++ b/include/config_file.h
@@ -179,12 +179,11 @@ void load_slot_status(RaucSlot *dest_slot);
  * unmounts the slot afterwards.
  *
  * @param dest_slot Slot to write status information for
- * @param mfimage image that was just installed
  * @param error return location for a GError, or NULL
  *
  * @return TRUE if slot is not mountable or saving status succeeded, FALSE otherwise
  */
-gboolean save_slot_status(RaucSlot *dest_slot, RaucImage *mfimage, GError **error);
+gboolean save_slot_status(RaucSlot *dest_slot, GError **error);
 
 /**
  * Frees the memory allocated by a RaucSlot
diff --git a/src/config_file.c b/src/config_file.c
index 8acfbf7..1e546d9 100644
--- a/src/config_file.c
+++ b/src/config_file.c
@@ -500,15 +500,13 @@ free:
 }
 
 
-gboolean save_slot_status(RaucSlot *dest_slot, RaucImage *mfimage, GError **error) {
+gboolean save_slot_status(RaucSlot *dest_slot, GError **error) {
 	GError *ierror = NULL;
 	gboolean res = FALSE;
 	gchar *slotstatuspath = NULL;
-	RaucSlotStatus *slot_state = NULL;
 
 	g_return_val_if_fail(dest_slot, FALSE);
 	g_return_val_if_fail(dest_slot->status, FALSE);
-	g_return_val_if_fail(mfimage, FALSE);
 	g_return_val_if_fail(error == NULL || *error == NULL, FALSE);
 
 	if (!is_slot_mountable(dest_slot)) {
@@ -523,17 +521,10 @@ gboolean save_slot_status(RaucSlot *dest_slot, RaucImage *mfimage, GError **erro
 		goto free;
 	}
 
-	slot_state = dest_slot->status;
-	g_free(slot_state->status);
-	slot_state->status = g_strdup("ok");
-	slot_state->checksum.type = mfimage->checksum.type;
-	g_free(slot_state->checksum.digest);
-	slot_state->checksum.digest = g_strdup(mfimage->checksum.digest);
-
 	slotstatuspath = g_build_filename(dest_slot->mount_point, "slot.raucs", NULL);
 	g_message("Updating slot file %s", slotstatuspath);
 
-	res = write_slot_status(slotstatuspath, slot_state, &ierror);
+	res = write_slot_status(slotstatuspath, dest_slot->status, &ierror);
 	if (!res) {
 		g_propagate_error(error, ierror);
 		r_umount_slot(dest_slot, NULL);
diff --git a/src/install.c b/src/install.c
index 903be90..551044d 100644
--- a/src/install.c
+++ b/src/install.c
@@ -924,10 +924,17 @@ static gboolean launch_and_wait_default_handler(RaucInstallArgs *args, gchar* bu
 			goto out;
 		}
 
+		g_free(slot_state->status);
+		g_free(slot_state->checksum.digest);
+
+		slot_state->status = g_strdup("ok");
+		slot_state->checksum.type = mfimage->checksum.type;
+		slot_state->checksum.digest = g_strdup(mfimage->checksum.digest);
+
 		r_context_end_step("copy_image", TRUE);
 
 		install_args_update(args, g_strdup_printf("Updating slot %s status", dest_slot->name));
-		res = save_slot_status(dest_slot, mfimage, &ierror);
+		res = save_slot_status(dest_slot, &ierror);
 		if (!res) {
 			g_propagate_prefixed_error(error, ierror, "Error while writing status file: ");
 			goto out;
-- 
2.14.1

