From 2ca9b506a21cf31cb801e183fc46dcb0970b8d67 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ulrich=20=C3=96lmann?= <u.oelmann@pengutronix.de>
Date: Thu, 22 Feb 2018 20:49:11 +0100
Subject: [PATCH 34/44] src: consolidate variables in the context of hashtable
 iteration
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Ulrich Ã–lmann <u.oelmann@pengutronix.de>
---
 src/config_file.c |  3 +--
 src/main.c        | 28 +++++++++++-----------------
 2 files changed, 12 insertions(+), 19 deletions(-)

diff --git a/src/config_file.c b/src/config_file.c
index 1e760d8..9ba6c86 100644
--- a/src/config_file.c
+++ b/src/config_file.c
@@ -698,7 +698,6 @@ free:
 }
 
 static gboolean save_slot_status_globally(GError **error) {
-	GHashTable *slots = r_context()->config->slots;
 	GKeyFile *key_file = g_key_file_new();
 	GError *ierror = NULL;
 	GHashTableIter iter;
@@ -712,7 +711,7 @@ static gboolean save_slot_status_globally(GError **error) {
 	g_debug("Saving global slot status");
 
 	/* Save all slot status information */
-	g_hash_table_iter_init(&iter, slots);
+	g_hash_table_iter_init(&iter, r_context()->config->slots);
 	while (g_hash_table_iter_next(&iter, NULL, (gpointer) &slot)) {
 		if (!slot->status) {
 			continue;
diff --git a/src/main.c b/src/main.c
index 01afb4b..29430cb 100644
--- a/src/main.c
+++ b/src/main.c
@@ -913,11 +913,11 @@ static gchar* slotstate_to_str(SlotState slotstate)
 static gchar* r_status_formatter_readable(void)
 {
 	GHashTableIter iter;
-	gpointer key, value;
 	gint slotcnt = 0;
 	GString *text = g_string_new(NULL);
 	GError *ierror = NULL;
-	RaucSlot *primary = NULL;
+	RaucSlot *slot, *primary = NULL;
+	gchar *name;
 
 	primary = r_boot_get_primary(&ierror);
 	if (!primary) {
@@ -932,9 +932,7 @@ static gchar* r_status_formatter_readable(void)
 
 	g_string_append(text, "slot states:\n");
 	g_hash_table_iter_init(&iter, r_context()->config->slots);
-	while (g_hash_table_iter_next(&iter, &key, &value)) {
-		gchar *name = key;
-		RaucSlot *slot = value;
+	while (g_hash_table_iter_next(&iter, (gpointer*) &name, (gpointer*) &slot)) {
 		RaucSlotStatus *slot_state = slot->status;
 		gboolean good = FALSE;
 
@@ -995,13 +993,13 @@ static gchar* r_status_formatter_readable(void)
 static gchar* r_status_formatter_shell(void)
 {
 	GHashTableIter iter;
-	gpointer key, value;
 	gint slotcnt = 0;
 	GString *text = g_string_new(NULL);
 	GPtrArray *slotnames, *slotnumbers = NULL;
 	gchar* slotstring = NULL;
 	GError *ierror = NULL;
-	RaucSlot *primary = NULL;
+	RaucSlot *slot, *primary = NULL;
+	gchar *name;
 
 	primary = r_boot_get_primary(&ierror);
 	if (!primary) {
@@ -1017,8 +1015,8 @@ static gchar* r_status_formatter_shell(void)
 	slotnames = g_ptr_array_new();
 	slotnumbers = g_ptr_array_new();
 	g_hash_table_iter_init(&iter, r_context()->config->slots);
-	while (g_hash_table_iter_next(&iter, &key, &value)) {
-		g_ptr_array_add(slotnames, (gchar*) key);
+	while (g_hash_table_iter_next(&iter, (gpointer*) &name, NULL)) {
+		g_ptr_array_add(slotnames, name);
 		g_ptr_array_add(slotnumbers, g_strdup_printf("%i", ++slotcnt));
 	}
 	g_ptr_array_add(slotnames, NULL);
@@ -1036,8 +1034,7 @@ static gchar* r_status_formatter_shell(void)
 
 	slotcnt = 0;
 	g_hash_table_iter_init(&iter, r_context()->config->slots);
-	while (g_hash_table_iter_next(&iter, &key, &value)) {
-		RaucSlot *slot = value;
+	while (g_hash_table_iter_next(&iter, NULL, (gpointer*) &slot)) {
 		RaucSlotStatus *slot_state = slot->status;
 		gboolean good = FALSE;
 
@@ -1091,11 +1088,10 @@ static gchar* r_status_formatter_json(gboolean pretty)
 	JsonGenerator *gen;
 	JsonNode * root;
 	GHashTableIter iter;
-	gpointer key, value;
 	gchar *str;
 	JsonBuilder *builder = json_builder_new ();
 	GError *ierror = NULL;
-	RaucSlot *primary = NULL;
+	RaucSlot *slot, *primary = NULL;
 
 	primary = r_boot_get_primary(&ierror);
 	if (!primary) {
@@ -1121,8 +1117,7 @@ static gchar* r_status_formatter_json(gboolean pretty)
 	json_builder_begin_array (builder);
 
 	g_hash_table_iter_init(&iter, r_context()->config->slots);
-	while (g_hash_table_iter_next(&iter, &key, &value)) {
-		RaucSlot *slot = value;
+	while (g_hash_table_iter_next(&iter, NULL, (gpointer*) &slot)) {
 		RaucSlotStatus *slot_state = slot->status;
 		gboolean good = FALSE;
 
@@ -1337,11 +1332,10 @@ static gboolean status_start(int argc, char **argv)
 
 	if (status_detailed) {
 		if (!ENABLE_SERVICE) {
-			GHashTable *slots = r_context()->config->slots;
 			GHashTableIter iter;
 			RaucSlot *slot;
 
-			g_hash_table_iter_init(&iter, slots);
+			g_hash_table_iter_init(&iter, r_context()->config->slots);
 			while (g_hash_table_iter_next(&iter, NULL, (gpointer) &slot))
 				load_slot_status(slot);
 		} else if (!retrieve_slot_states_via_dbus(&ierror)) {
-- 
2.14.1

